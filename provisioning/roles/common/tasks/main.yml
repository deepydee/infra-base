---
- name: Set hostname
  hostname:
    name: "{{ hostname }}"

- name: Set timezone
  timezone:
    name: "{{ timezone }}"

- name: Force Update apt cache
  apt:
    update_cache: yes
    # Removed cache_valid_time to force real update on fresh systems

- name: Install basic utilities
  apt:
    name:
      - curl
      - wget
      - git
      - htop
      - vim
      - ncdu
      - ufw
      - fail2ban
      - gnupg
      - lsb-release
      - ca-certificates
      - python3-pip
      - python3-venv
    state: present

# Swap Configuration (8GB)
- name: Check if swap file exists
  stat:
    path: /swapfile
  register: swap_file_check

- name: Create swap file
  command: fallocate -l 8G /swapfile
  when: not swap_file_check.stat.exists

- name: Set permissions on swap file
  file:
    path: /swapfile
    mode: 0600

- name: Make swap
  command: mkswap /swapfile
  when: not swap_file_check.stat.exists

- name: Add swap to fstab
  mount:
    path: none
    src: /swapfile
    fstype: swap
    opts: sw
    state: present

- name: Turn on swap
  command: swapon /swapfile
  when: not swap_file_check.stat.exists

- name: Set swapiness
  sysctl:
    name: vm.swappiness
    value: '10'
    state: present

# Cleanup
- name: Remove useless packages from the cache
  apt:
    autoclean: yes

- name: Remove dependencies that are no longer needed
  apt:
    autoremove: yes
