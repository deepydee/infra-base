---
- name: Ensure deployment user exists
  user:
    name: "{{ create_user }}"
    groups: sudo,docker
    append: yes
    shell: /bin/bash
    state: present

- name: Set authorized key for deployment user
  authorized_key:
    user: "{{ create_user }}"
    state: present
    key: "{{ create_user_key }}"

- name: Allow sudo without password for deployment user
  lineinfile:
    path: /etc/sudoers.d/{{ create_user }}
    line: "{{ create_user }} ALL=(ALL) NOPASSWD: ALL"
    state: present
    create: yes
    mode: 0440
    validate: 'visudo -cf %s'

# UFW Configuration
- name: Install UFW
  apt:
    name: ufw
    state: present

- name: Allow OpenSSH (Standard port backup)
  ufw:
    rule: allow
    port: 22
    proto: tcp

- name: Allow Custom SSH port
  ufw:
    rule: allow
    port: "{{ ssh_port }}"
    proto: tcp

- name: Allow GitLab SSH port
  ufw:
    rule: allow
    port: 2222
    proto: tcp

- name: Allow HTTP
  ufw:
    rule: allow
    port: 80
    proto: tcp

- name: Allow HTTPS
  ufw:
    rule: allow
    port: 443
    proto: tcp

- name: Enable UFW
  ufw:
    state: enabled
    policy: deny

# SSH Hardening
- name: Update SSH configuration
  template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: 0644
  notify: Restart sshd

# Fail2Ban Configuration
- name: Configure Fail2Ban jail.local
  copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [sshd]
      enabled = true
      port = {{ ssh_port }}
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 3600
  notify: Restart fail2ban
